{% extends 'gifts/base.html' %}

{% block title %}Conversation{% endblock %}

{% block content %}
  <div id="chat-root" data-conv-id="{{ conversation.id }}" class="chat-main">
    <div class="chat-header">
      <div class="me-3">
        {% if other and other.profile.avatar %}
          <img src="{{ other.profile.avatar.url }}" width="48" height="48" class="rounded-circle">
        {% else %}
          <div class="rounded-circle bg-secondary" style="width:48px;height:48px"></div>
        {% endif %}
      </div>
      <div>
        <div class="fw-bold">{% if other %}{{ other.profile.display_name|default:other.username }}{% else %}–†–æ–∑–º–æ–≤–∞ {{ conversation.id }}{% endif %}</div>
      </div>
    </div>

  <div class="chat-messages" id="messages">
      {% for m in chat_messages %}
        <div class="msg {% if m.sender == request.user %}me{% else %}them{% endif %}">
          <div class="d-flex justify-content-between">
            <div><strong>{% if m.sender == request.user %}–í–∏{% else %}{{ m.sender.username }}{% endif %}</strong></div>
            <div class="text-muted small">{{ m.created_at|date:'H:i' }}</div>
          </div>
          <div class="mt-1">{{ m.text }}</div>
          {% if m.forwarded_gift %}
            <div class="forwarded-gift border p-2 mt-2 d-flex align-items-center">
              {% if m.forwarded_gift.image %}
                <img src="{{ m.forwarded_gift.image.url }}" width="64" height="64" class="me-2">
              {% endif %}
              <div>
                <div class="fw-bold">–ü–µ—Ä–µ—Å–ª–∞–Ω–∏–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫</div>
                <a href="{% url 'gifts:gift_detail' m.forwarded_gift.id %}">{{ m.forwarded_gift.title }}</a>
              </div>
            </div>
          {% endif %}
        </div>
      {% empty %}
        <div class="text-center text-muted p-3">–ü–æ—á–Ω—ñ—Ç—å —Ä–æ–∑–º–æ–≤—É ‚Äî –Ω–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∏–∂—á–µ.</div>
      {% endfor %}
    </div>

    <div class="chat-input">
      <form id="msg-form" class="input-group">
        <input name="text" class="form-control" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off">
        <a id="share-input-btn" class="btn btn-outline-secondary" title="–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –ø–æ–¥–∞—Ä—É–Ω–∫–æ–º" href="{% url 'chat:forward_saved' conversation.id %}">üîÅ</a>
        <button class="btn btn-primary" type="submit">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
      </form>
    </div>
  </div>

{% endblock %}

{% block extra_js %}
<!-- Saved gifts JSON for modal (from view context) -->
<script id="saved-gifts-json" type="application/json">[
{% for g in saved_gifts %}
  {"id": {{ g.id }}, "title": "{{ g.title|escapejs }}", "image": {% if g.image %}"{{ g.image }}"{% else %}null{% endif %}}{% if not forloop.last %},{% endif %}
{% endfor %}
]</script>

<!-- User conversations JSON (from view context) -->
<script id="user-convs-json" type="application/json">[
{% for c in user_conversations %}
  {"id": {{ c.id }}, "label": "{{ c.label|escapejs }}" }{% if not forloop.last %},{% endif %}
{% endfor %}
]</script>
<!-- Bootstrap-like modal with search and multi-select for conversations -->
<div id="shareModal" class="d-none position-fixed top-0 start-0 w-100 h-100" style="background: rgba(0,0,0,0.45); z-index:1060;">
  <div class="bg-white p-3 rounded" style="width:680px; margin:60px auto;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="m-0">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –ø–æ–¥–∞—Ä—É–Ω–∫–æ–º</h5>
      <div>
        <button id="close-share-modal" class="btn btn-sm btn-light me-2">‚úñ</button>
      </div>
    </div>
    <div class="row">
      <div class="col-6">
        <input id="conv-search" class="form-control mb-2" placeholder="–ü–æ—à—É–∫ —Ä–æ–∑–º–æ–≤ –∞–±–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞...">
        <div id="conversations-list" style="max-height:380px; overflow:auto; border:1px solid #e9ecef; padding:8px; border-radius:6px;"></div>
      </div>
          <div class="col-6">
            <div class="mb-2"><strong>–ó–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ–¥–∞—Ä—É–Ω–∫–∏</strong></div>
            <div id="saved-gifts-list" style="max-height:420px; overflow:auto; border:1px solid #e9ecef; padding:8px; border-radius:6px;"></div>
            <div class="mt-2 text-muted small">–ö–ª—ñ–∫–Ω—ñ—Ç—å –ø–æ –ø–æ–¥–∞—Ä—É–Ω–∫—É, —â–æ–± –æ–¥—Ä–∞–∑—É –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –π–æ–≥–æ –≤ –ø–æ—Ç–æ—á–Ω—É —Ä–æ–∑–º–æ–≤—É.</div>
          </div>
    </div>
  </div>
</div>

<!-- Toasts container -->
<div id="toast-container" style="position:fixed; top:20px; right:20px; z-index:2000;"></div>

<script>
const savedGifts = JSON.parse(document.getElementById('saved-gifts-json').textContent || '[]');
// conversations passed from view
const conversations = JSON.parse(document.getElementById('user-convs-json').textContent || '[]');

function showToast(message, type='success'){
  const id = 't'+Math.random().toString(36).slice(2,9);
  const el = document.createElement('div');
  el.id = id;
  el.className = `alert alert-${type}`;
  el.style.marginTop = '6px';
  el.innerText = message;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>{ try{ el.remove(); }catch(e){} }, 3500);
}

function renderConversations(filter=''){
  const list = document.getElementById('conversations-list');
  list.innerHTML = '';
  const f = filter.trim().toLowerCase();
  conversations.filter(c=>!f || c.label.toLowerCase().includes(f) || String(c.id)===f).forEach(c=>{
    const row = document.createElement('div');
    row.className = 'form-check d-flex align-items-center justify-content-between p-2';
    row.innerHTML = `<label class="form-check-label"> <input class="form-check-input me-2 conv-checkbox" type="checkbox" value="${c.id}"> ${escapeHtml(c.label)} </label>`;
    list.appendChild(row);
  });
}

function renderSavedGifts(){
  const list = document.getElementById('saved-gifts-list');
  list.innerHTML = '';
  if(savedGifts.length===0){ list.innerHTML = '<p class="text-muted">–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤.</p>'; return }
  savedGifts.forEach(g=>{
    const el = document.createElement('div');
    el.className = 'd-flex align-items-center mb-2 p-2 border rounded saved-gift-item';
    el.style.cursor = 'pointer';
    el.dataset.giftId = g.id;
    el.innerHTML = `
      ${g.image? `<img src="${g.image}" width="70" height="70" class="me-2"/>` : ''}
      <div class="flex-grow-1"> <div class="fw-bold">${escapeHtml(g.title)}</div> </div>
    `;
    // clicking the gift will immediately send it to current conversation
    el.addEventListener('click', async function(){
      const convId = document.getElementById('chat-root')?.dataset?.convId;
      if(!convId){ showToast('–ü–æ—Ç–æ—á–Ω—É —Ä–æ–∑–º–æ–≤—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ','danger'); return }
      const giftId = this.dataset.giftId;
      showToast('–ù–∞–¥—Å–∏–ª–∞—é –ø–æ–¥–∞—Ä—É–Ω–æ–∫...');
      try{
        const form = new FormData(); form.append('text','–ü–æ–¥—ñ–ª–∏–≤—Å—è –ø–æ–¥–∞—Ä—É–Ω–∫–æ–º'); form.append('forwarded_gift_id', giftId);
        const res = await fetch(`/chat/conversation/${convId}/send/`, {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}});
        if(res.ok){
          const data = await res.json();
          appendMessageToDOM(data);
          showToast('–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ');
          document.getElementById('shareModal').classList.add('d-none');
        } else {
          showToast('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è','danger');
        }
      }catch(e){ showToast('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ','danger'); console.error(e); }
    });
    list.appendChild(el);
  });
}

let selectedGiftId = null;
// open modal from the input-area share button
function openShareModal(convId=null){
  const modal = document.getElementById('shareModal');
  modal.classList.remove('d-none');
  modal.style.display = 'block';
  modal.style.zIndex = '9999';
  console.log('openShareModal called, convId=', convId);
  try{ showToast('–í—ñ–¥–∫—Ä–∏–≤–∞—é –≤—ñ–∫–Ω–æ –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è...'); }catch(e){ console.log('toast err',e); }
  renderConversations(); renderSavedGifts();
  // preselect current conversation checkbox (or use provided convId)
  const currentConvId = convId || document.getElementById('chat-root')?.dataset?.convId;
  if(currentConvId){
    setTimeout(()=>{
      const cb = document.querySelector(`.conv-checkbox[value="${currentConvId}"]`);
      if(cb) cb.checked = true;
    }, 0);
  }
}
// expose globally for onclick inline handlers
window.openShareModal = openShareModal;

// handle selects for gifts
document.addEventListener('click', function(e){
  if(e.target.classList.contains('select-gift-btn')){
    // highlight selected
    document.querySelectorAll('.select-gift-btn').forEach(b=>b.classList.remove('btn-primary'));
    e.target.classList.add('btn-primary');
    selectedGiftId = e.target.dataset.giftId;
    console.log('selectedGiftId set to', selectedGiftId);
    showToast('–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –æ–±—Ä–∞–Ω–æ');
  }
});

document.getElementById('conv-search').addEventListener('input', function(e){ renderConversations(e.target.value); });
document.getElementById('close-share-modal').addEventListener('click', ()=>{ document.getElementById('shareModal').classList.add('d-none'); selectedGiftId=null; });

document.getElementById('share-to-selected').addEventListener('click', async function(){
  if(!selectedGiftId) return showToast('–û–±–µ—Ä—ñ—Ç—å –ø–æ–¥–∞—Ä—É–Ω–æ–∫', 'danger');
  const checks = Array.from(document.querySelectorAll('.conv-checkbox:checked')).map(i=>i.value);
  if(checks.length===0) return showToast('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á –æ–¥–Ω—É —Ä–æ–∑–º–æ–≤—É', 'danger');
  // send to each selected conversation
  for(const convId of checks){
    console.log('sending to conv', convId, 'gift', selectedGiftId);
    const form = new FormData(); form.append('text','–ü–æ–¥—ñ–ª–∏–≤—Å—è –ø–æ–¥–∞—Ä—É–Ω–∫–æ–º'); form.append('forwarded_gift_id', selectedGiftId);
    try{
      const res = await fetch(`/chat/conversation/${convId}/send/`, {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}});
        if(res.ok){
          showToast(`–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–æ–∑–º–æ–≤—É ${convId}`,'success');
          // if this is the current conversation, append message dynamically
          const currentConvId = document.getElementById('chat-root')?.dataset?.convId;
          if(String(convId)===String(currentConvId)){
            const data = await res.json();
            appendMessageToDOM(data);
          }
        } else {
        showToast(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –≤ ${convId}`,'danger');
      }
    }catch(err){ showToast('Network error','danger'); }
  }
  document.getElementById('shareModal').classList.add('d-none'); selectedGiftId=null;
});

function appendMessageToDOM(data){
  // data expected: {id, text, sender}
  const messages = document.getElementById('messages');
  const div = document.createElement('div'); div.className='msg me';
  const timeDisplay = data.created_at_display || '–∑–∞—Ä–∞–∑';
  div.innerHTML = `
    <div class="d-flex justify-content-between"><div><strong>–í–∏</strong></div><div class="text-muted small">${timeDisplay}</div></div>
    <div class="mt-1">${escapeHtml(data.text)}</div>
    ${data.forwarded? `<div class="forwarded-gift border p-2 mt-2 d-flex align-items-center"><img src="${data.forwarded.image||''}" width="64" height="64" class="me-2"><div><div class="fw-bold">–ü–µ—Ä–µ—Å–ª–∞–Ω–∏–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫</div><a href="/gifts/${data.forwarded.id}/">${escapeHtml(data.forwarded.title)}</a></div></div>` : ''}
  `;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function escapeHtml(s){ return (s||'').replace(/[&<>\\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function getCookie(name) { const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return parts.pop().split(';').shift(); }
</script>
{% endblock %}
